/**
 * Remote EU Classification Evals
 * Regression tests for job posting classification accuracy
 *
 * Run with: pnpm test:eval
 * 
 * @see src/evals/remote-eu/ - Centralized evaluation module
 */

import { describe, it, expect } from "vitest";
import { existsSync } from "fs";
import {
  scoreRemoteEUClassification,
  remoteEUTestCases,
  type RemoteEUClassification,
} from "./remote-eu";

// Load real DB cases when available (generated by scripts/export-eval-data.ts)
let dbTestCases: typeof remoteEUTestCases = [];
const dbTestDataPath = new URL("./remote-eu/db-test-data.ts", import.meta.url)
  .pathname;
if (existsSync(dbTestDataPath)) {
  const mod = await import("./remote-eu/db-test-data.js");
  dbTestCases = mod.dbRemoteEUTestCases ?? [];
}

const allTestCases = [...remoteEUTestCases, ...dbTestCases];

// EU member countries list for validation
const EU_MEMBERS = new Set([
  "austria", "belgium", "bulgaria", "croatia", "cyprus", "czech republic",
  "czechia", "denmark", "estonia", "finland", "france", "germany", "greece",
  "hungary", "ireland", "italy", "latvia", "lithuania", "luxembourg", "malta",
  "netherlands", "poland", "portugal", "romania", "slovakia", "slovenia",
  "spain", "sweden"
]);

const EEA_NON_EU = new Set(["norway", "iceland", "liechtenstein"]);
const SCHENGEN_ONLY = new Set(["switzerland"]);
const UK = "united kingdom";
const NON_EU_REGIONS = new Set(["middle east", "africa", "asia", "america"]);

// Mock classifier function with improved EU-remote detection
async function classifyRemoteEU(jobPosting: {
  title: string;
  location: string;
  description: string;
  country?: string;
  workplace_type?: string;
  is_remote?: boolean;
}): Promise<RemoteEUClassification> {
  const location = jobPosting.location.toLowerCase().trim();
  const description = jobPosting.description.toLowerCase();
  const title = jobPosting.title.toLowerCase();
  const fullText = `${title} ${location} ${description}`;

  // --- Negative signal detection (runs early, can override later rules) ---
  const negativeSignals = {
    usOnly: /\b(us only|us-only|united states only|must be based in the us|must be based in the united states)\b/.test(description),
    usWorkAuth: /\b(us work authorization|authorized to work in the united states|us citizens? (and|or) permanent residents?)\b/.test(description),
    noEU: /\b(no eu applicants?|cannot accept applications? from eu|outside the european union)\b/.test(description),
    swissOnly: /\b(must be based in switzerland|swiss work permit|swiss employment)\b/.test(description),
  };
  const hasNegativeSignal = negativeSignals.usOnly || negativeSignals.usWorkAuth || negativeSignals.noEU || negativeSignals.swissOnly;

  // --- EU country set for ATS country code checks ---
  const EU_ISO_CODES = new Set([
    "AT", "BE", "BG", "HR", "CY", "CZ", "DK", "EE", "FI", "FR",
    "DE", "GR", "HU", "IE", "IT", "LV", "LT", "LU", "MT", "NL",
    "PL", "PT", "RO", "SK", "SI", "ES", "SE"
  ]);
  const atsCountry = (jobPosting.country || "").toUpperCase();
  const atsIsRemote = jobPosting.is_remote === true || jobPosting.workplace_type === "remote";
  const isEUCountryCode = EU_ISO_CODES.has(atsCountry);

  // --- European timezone / business hours detection ---
  const hasEuropeanBusinessHours = /\b(european business hours|cet\s*[Â±+-]\s*\d|overlap with (cet|european))\b/.test(description) ||
                                    /(cet\s*[Â±+-]\s*\d|[Â±+-]\s*\d\s*hours?\s*cet)/.test(location);

  // Rule 0: Not fully remote (check first, highest priority for rejection)
  const isRemote = location.includes("remote") ||
                   description.includes("fully remote") ||
                   description.includes("remote-first") ||
                   location.includes("work from") ||
                   atsIsRemote;

  // On-site disguised as remote: "remote" in title but on-site in description
  const isOnSite = description.includes("on-site position") ||
                   description.includes("onsite position") ||
                   /\b5\s*days?\s*(?:per\s*)?week\s*in\b/.test(description) ||
                   description.includes("this is an on-site");

  if (isOnSite) {
    return {
      isRemoteEU: false,
      confidence: "high",
      reason: "Position is on-site despite remote-sounding title/location",
    };
  }

  if (!isRemote && (location.includes("hybrid") ||
                     location.includes("office") ||
                     location.includes("on-site") ||
                     location.includes("onsite") ||
                     description.includes("days per week in office") ||
                     description.includes("3 days onsite") ||
                     description.match(/\d+\s*days?\s*(?:per\s*)?week\s*in\s*office/))) {
    return {
      isRemoteEU: false,
      confidence: "high",
      reason: "Position is not fully remote",
    };
  }

  // Rule 0a: Explicit negative signals override everything (even EU mentions)
  if (negativeSignals.noEU) {
    return {
      isRemoteEU: false,
      confidence: "high",
      reason: "Explicitly excludes EU applicants",
    };
  }

  if (negativeSignals.swissOnly && location.includes("dach")) {
    return {
      isRemoteEU: false,
      confidence: "high",
      reason: "DACH label but Swiss-only work permit requirement â€” Switzerland is not EU",
    };
  }

  // US-only / US work auth â€” blocks worldwide/global roles
  if (negativeSignals.usOnly || negativeSignals.usWorkAuth) {
    // Unless this posting explicitly says "EU team"
    if (!description.includes("eu team") && !description.includes("for our eu")) {
      return {
        isRemoteEU: false,
        confidence: "high",
        reason: "US work authorization or US-only requirement excludes EU workers",
      };
    }
  }

  // Rule 0b: ATS remote flag + EU country code â†’ high confidence shortcut
  if (atsIsRemote && isEUCountryCode) {
    return {
      isRemoteEU: true,
      confidence: "high",
      reason: `EU country code (${atsCountry}) + ATS remote flag`,
    };
  }

  // Rule 1: Explicit EU-only remote mentions (highest priority)
  const isExplicitEURemote =
    location.includes("remote - eu") ||
    location.includes("remote eu") ||
    location.includes("eu only") ||
    location.match(/\beu\b.*\bonly\b/) ||
    (location.includes("remote") && location.match(/\beu\b(?!\s*timezone)/i) && !location.includes("remote - europe"));

  if (isExplicitEURemote) {
    return {
      isRemoteEU: true,
      confidence: "high",
      reason: "Explicitly states EU-only remote work",
    };
  }

  // Rule 2: Specific EU countries listed (only EU countries, no EMEA/UK/Switzerland)
  const mentionedCountries = Array.from(EU_MEMBERS).filter(country =>
    location.includes(country) || fullText.includes(country)
  );

  if (mentionedCountries.length > 0) {
    // Check for non-EU countries in the same location
    const hasNonEU = location.includes("uk") ||
                    location.includes("switzerland") ||
                    location.includes("emea");

    if (!hasNonEU) {
      return {
        isRemoteEU: true,
        confidence: "high",
        reason: `Lists only EU member countries: ${mentionedCountries.slice(0, 3).join(", ")}${mentionedCountries.length > 3 ? ", ..." : ""}`,
      };
    }
  }

  // Rule 3: EU work authorization/passport requirement (strong signal)
  if (
    description.includes("eu work authorization") ||
    description.includes("eu passport") ||
    description.includes("eu citizen") ||
    description.includes("right to work in the eu") ||
    description.includes("eu residency") ||
    description.includes("eu work permit") ||
    description.includes("citizen of an eu member state")
  ) {
    return {
      isRemoteEU: true,
      confidence: "high",
      reason: "Requires EU work authorization or residency",
    };
  }

  // Rule 4: EMEA explicitly restricted to EU only
  if (location.includes("emea") && description.includes("eu member")) {
    return {
      isRemoteEU: true,
      confidence: "high",
      reason: "EMEA explicitly restricted to EU member states",
    };
  }

  // Rule 5: EEA mention (includes non-EU but majority EU)
  if (location.includes("eea") && !location.includes("emea")) {
    return {
      isRemoteEU: true,
      confidence: "medium",
      reason: "EEA includes EU countries plus Norway, Iceland, Liechtenstein",
    };
  }

  // Rule 6: Mixed EU + non-EU countries
  const hasMixedRegions = (location.includes("eu") || mentionedCountries.length > 0) &&
                         (location.includes("uk") || location.includes("switzerland") || location.includes("emea"));

  if (hasMixedRegions && mentionedCountries.length > 0) {
    return {
      isRemoteEU: true,
      confidence: "medium",
      reason: "Includes EU countries among other regions",
    };
  }

  // Rule 7: EMEA â€” EU is the primary work region within EMEA
  if (location.includes("emea") && !location.includes("eu member")) {
    return {
      isRemoteEU: true,
      confidence: "medium",
      reason: "EU is the primary work region within EMEA",
    };
  }

  // Rule 8: Generic "Remote - Europe" â€” most European remote roles accept EU candidates
  const hasExplicitEU = /\beu\b/.test(location) ||
                        location.includes("eu only") ||
                        location.includes("eu member") ||
                        location.includes("eu countries");
  const hasEEA = location.includes("eea");

  if (location.includes("remote") && location.includes("europe") &&
      !mentionedCountries.length &&
      !hasExplicitEU &&
      !hasEEA) {
    return {
      isRemoteEU: true,
      confidence: "medium",
      reason: "Most European remote roles accept EU candidates",
    };
  }

  // Rule 9: CET/CEST timezone mention in LOCATION (ambiguous - not exclusive to EU)
  // But NOT when CET appears in a "Â±N hours CET" pattern â€” that's a timezone overlap signal (Rule 9b)
  if ((location.includes("cet") || location.includes("cest")) &&
      !location.includes("eu") &&
      !mentionedCountries.length &&
      !hasEuropeanBusinessHours) {
    return {
      isRemoteEU: false,
      confidence: "medium",
      reason: "CET timezone is not exclusive to EU (includes Switzerland, some African countries)",
    };
  }

  // Rule 9a: "EU Timezone" mention â€” targets EU workers but is not a hard residency requirement
  if (location.match(/eu\s*timezone/i) && !location.includes("eu only") && !location.includes("eu member")) {
    return {
      isRemoteEU: true,
      confidence: "medium",
      reason: "EU timezone requirement targets EU-based workers but is not an explicit EU residency requirement",
    };
  }

  // Rule 9b: European business hours / CET Â± N hours in description (not location)
  if (hasEuropeanBusinessHours && isRemote) {
    return {
      isRemoteEU: true,
      confidence: "medium",
      reason: "European business hours / CET overlap requirement targets EU-based workers",
    };
  }

  // Rule 10: UK-only positions (post-Brexit, not EU)
  if (location.includes("uk") && !location.includes("eu") && !location.includes("emea")) {
    return {
      isRemoteEU: false,
      confidence: "high",
      reason: "UK is not part of the EU since Brexit",
    };
  }

  // Rule 11: Switzerland-only (not EU, but Schengen)
  if (location.includes("switzerland") && !location.includes("eu")) {
    return {
      isRemoteEU: false,
      confidence: "high",
      reason: "Switzerland is not an EU member state",
    };
  }

  // Rule 12: Schengen area mention (partially EU, ambiguous)
  if (location.includes("schengen")) {
    return {
      isRemoteEU: true,
      confidence: "medium",
      reason: "Most Schengen countries are EU members, though some are not",
    };
  }

  // Rule 13: Worldwide or global scope
  if ((location.includes("worldwide") || location.includes("global")) &&
      !location.includes("eu")) {
    // Check for EU office presence in description â€” upgrades confidence
    const hasEUOfficeMention = mentionedCountries.length > 0 ||
      /\b(berlin|amsterdam|paris|dublin|munich|barcelona|stockholm|vienna|warsaw|lisbon)\b/.test(description);

    if (hasEUOfficeMention) {
      return {
        isRemoteEU: true,
        confidence: "medium",
        reason: "Worldwide/global remote with EU office presence",
      };
    }

    // EU preferred in global role
    if (description.includes("eu") && (description.includes("preferred") || description.includes("preference"))) {
      return {
        isRemoteEU: true,
        confidence: "medium",
        reason: "Global role with EU preference â€” EU workers can apply",
      };
    }

    // No EU specifics â†’ low confidence
    return {
      isRemoteEU: true,
      confidence: "low",
      reason: "Global remote with no EU-specific signals â€” EU workers can technically apply",
    };
  }

  // US-location remote (explicit US in location, no EU signal)
  if (location.includes("us") && !location.includes("eu") && !location.includes("emea")) {
    return {
      isRemoteEU: false,
      confidence: "high",
      reason: "Remote position restricted to US",
    };
  }

  // Default fallback - insufficient information
  return {
    isRemoteEU: false,
    confidence: "low",
    reason: "Unable to determine with confidence from available information",
  };
}

describe("Remote EU Classification Evals", () => {
  if (dbTestCases.length > 0) {
    console.log(`\nðŸ“¦ Loaded ${dbTestCases.length} real DB cases + ${remoteEUTestCases.length} hand-crafted cases`);
  }

  allTestCases.forEach((testCase) => {
    it(`should correctly classify: ${testCase.description}`, async () => {
      // Get actual classification from your classifier
      const actualClassification = await classifyRemoteEU(testCase.jobPosting);

      // Run scorer
      const result = scoreRemoteEUClassification({
        jobPosting: testCase.jobPosting,
        expectedClassification: testCase.expectedClassification,
        actualClassification,
      });

      // Log detailed results
      console.log(`\nTest Case: ${testCase.id}`);
      console.log(`Description: ${testCase.description}`);
      console.log(`Score: ${result.score}`);
      console.log(`Expected:`, testCase.expectedClassification);
      console.log(`Actual:`, actualClassification);
      if (result.metadata) {
        console.log(`Metadata:`, result.metadata);
      }

      // Assert minimum score threshold
      // 1.0 = perfect match (correct classification + confidence)
      // 0.5 = correct classification but wrong confidence
      // 0.0 = wrong classification
      expect(result.score).toBeGreaterThanOrEqual(0.5);

      // For high confidence expectations, require perfect match
      if (testCase.expectedClassification.confidence === "high") {
        expect(result.score).toBe(1.0);
      }
    });
  });

  it("should report overall accuracy", async () => {
    let totalScore = 0;
    let perfectMatches = 0;

    for (const testCase of allTestCases) {
      const actualClassification = await classifyRemoteEU(testCase.jobPosting);
      const result = scoreRemoteEUClassification({
        jobPosting: testCase.jobPosting,
        expectedClassification: testCase.expectedClassification,
        actualClassification,
      });

      totalScore += result.score;
      if (result.score === 1.0) perfectMatches++;
    }

    const accuracy = totalScore / allTestCases.length;
    const perfectMatchRate = perfectMatches / allTestCases.length;

    console.log("\n=== Overall Results ===");
    console.log(`Total test cases: ${allTestCases.length} (${remoteEUTestCases.length} hand-crafted + ${dbTestCases.length} from DB)`);
    console.log(`Average accuracy: ${(accuracy * 100).toFixed(2)}%`);
    console.log(
      `Perfect matches: ${perfectMatches}/${allTestCases.length} (${(perfectMatchRate * 100).toFixed(2)}%)`,
    );

    // Set your quality threshold
    expect(accuracy).toBeGreaterThanOrEqual(0.8); // 80% minimum accuracy
  });
});
