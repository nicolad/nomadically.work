extend type Query {
  jobs(
    sourceType: String
    search: String
    limit: Int
    offset: Int
    excludedCompanies: [String!]
    isRemoteEu: Boolean
    remoteEuConfidence: String
    skills: [String!]
  ): JobsResponse!
  job(id: String!): Job
  userSettings(userId: String!): UserSettings
  textToSql(question: String!): TextToSqlResult!
  executeSql(sql: String!): TextToSqlResult!
}

extend type Mutation {
  updateUserSettings(
    userId: String!
    settings: UserSettingsInput!
  ): UserSettings!
  deleteJob(id: Int!): DeleteJobResponse!
  deleteAllJobs: DeleteJobResponse!
  """
  Trigger classification/enhancement of all unprocessed jobs via the Cloudflare Worker.
  Calls the classify-jobs CF worker (POST) which runs DeepSeek-based classification
  for remote-EU eligibility on every unclassified job.
  """
  processAllJobs(limit: Int): ProcessAllJobsResponse!
  """
  Enhance a job posting by fetching detailed data from the ATS (Applicant Tracking System).

  Supported ATS sources:
  - greenhouse: Greenhouse ATS (https://greenhouse.io)
  - ashby: Ashby ATS (https://ashbyhq.com)

  For Greenhouse:
  - jobId: The job posting ID from the URL (e.g., "5802159004" from https://job-boards.greenhouse.io/grafanalabs/jobs/5802159004)
  - company: The board token (e.g., "grafanalabs")

  For Ashby:
  - jobId: The posting ID
  - company: The board name

  The mutation will:
  1. Fetch comprehensive job data from the ATS API
  2. Save enhanced fields (description, departments, offices, questions, etc.)
  3. Return the updated job with full ATS data
  """
  enhanceJobFromATS(
    jobId: String! # The unique job/posting ID from the ATS
    company: String! # The company identifier (board_token for Greenhouse, board name for Ashby)
    source: String! # ATS source: "greenhouse" or "ashby"
  ): EnhanceJobResponse!
  """
  Report a job as irrelevant, spam, or incorrectly classified.
  Sets the job status to "reported" so it can be reviewed or excluded.
  Requires authentication.
  """
  reportJob(id: Int!): Job
}

type JobSkill {
  tag: String!
  level: String!
  confidence: Float
  evidence: String
}

type SkillMatchDetail {
  tag: String!
  level: String!
  matched: Boolean!
}

type SkillMatch {
  score: Float!
  userCoverage: Float!
  jobCoverage: Float!
  requiredCoverage: Float!
  matchedCount: Int!
  totalPreferred: Int!
  details: [SkillMatchDetail!]!
}

type GreenhouseDepartment {
  id: String!
  name: String!
  child_ids: [String!]
  parent_id: String
}

type GreenhouseOffice {
  id: String!
  name: String!
  location: String
  child_ids: [String!]
  parent_id: String
}

type GreenhouseQuestionField {
  type: String!
  name: String
}

type GreenhouseQuestion {
  description: String
  label: String!
  required: Boolean!
  fields: [GreenhouseQuestionField!]
}

type GreenhouseMetadata {
  id: String!
  name: String!
  value: String
  value_type: String
}

type GreenhouseDataCompliance {
  type: String!
  requires_consent: Boolean!
  requires_processing_consent: Boolean!
  requires_retention_consent: Boolean!
  retention_period: Int
  demographic_data_consent_applies: Boolean!
}

type GreenhouseCompliance {
  type: String!
  description: String
  questions: [GreenhouseQuestion!]
}

type GreenhouseDemographicQuestions {
  header: String
  description: String
  questions: [GreenhouseQuestion!]
}

# Ashby ATS types

type AshbyPostalAddress {
  addressLocality: String
  addressRegion: String
  addressCountry: String
}

type AshbyAddress {
  postalAddress: AshbyPostalAddress
}

type AshbySecondaryLocation {
  location: String!
  address: AshbyPostalAddress
}

type AshbyCompensationComponent {
  id: String
  summary: String
  compensationType: String
  interval: String
  currencyCode: String
  minValue: Float
  maxValue: Float
}

type AshbyCompensationTier {
  id: String
  tierSummary: String
  title: String
  additionalInformation: String
  components: [AshbyCompensationComponent!]!
}

type AshbyCompensation {
  compensationTierSummary: String
  scrapeableCompensationSalarySummary: String
  compensationTiers: [AshbyCompensationTier!]!
  summaryComponents: [AshbyCompensationComponent!]!
}

"""
Pipeline status for a job posting.
Mirrors workers/process-jobs/src/entry.py JobStatus enum — values must stay in sync.
"""
enum JobStatus {
  new
  enhanced
  role_match
  role_nomatch
  eu_remote
  non_eu
  error
  reported
}

"""
Confidence level of a classification result.
"""
enum ClassificationConfidence {
  high
  medium
  low
}

type Job {
  id: Int!
  external_id: String!
  source_id: String
  source_kind: String!
  company_id: Int
  company_key: String!
  company: Company
  title: String!
  location: String
  url: String!
  description: String
  posted_at: String!
  score: Float
  score_reason: String
  status: JobStatus
  """Whether this job is classified as Remote EU — read directly from the DB column."""
  is_remote_eu: Boolean!
  remote_eu_confidence: ClassificationConfidence
  remote_eu_reason: String
  skills: [JobSkill!]
  skillMatch: SkillMatch

  # Greenhouse ATS fields (parsed from ats_data)
  absolute_url: String
  internal_job_id: String
  requisition_id: String
  company_name: String
  first_published: String
  language: String
  metadata: [GreenhouseMetadata!]
  departments: [GreenhouseDepartment!]
  offices: [GreenhouseOffice!]
  questions: [GreenhouseQuestion!]
  location_questions: [GreenhouseQuestion!]
  compliance: [GreenhouseCompliance!]
  demographic_questions: GreenhouseDemographicQuestions
  data_compliance: [GreenhouseDataCompliance!]

  # Ashby ATS fields
  ashby_department: String
  ashby_team: String
  ashby_employment_type: String
  ashby_is_remote: Boolean
  ashby_is_listed: Boolean
  ashby_published_at: String
  ashby_job_url: String
  ashby_apply_url: String
  ashby_secondary_locations: [AshbySecondaryLocation!]
  ashby_compensation: AshbyCompensation
  ashby_address: AshbyAddress

  created_at: String!
  updated_at: String!
}

type JobsResponse {
  jobs: [Job!]!
  totalCount: Int!
}

type UserSettings {
  id: Int!
  user_id: String!
  email_notifications: Boolean!
  daily_digest: Boolean!
  new_job_alerts: Boolean!
  preferred_locations: [String!]
  preferred_skills: [String!]
  excluded_companies: [String!]
  dark_mode: Boolean!
  jobs_per_page: Int!
  created_at: String!
  updated_at: String!
}

input UserSettingsInput {
  email_notifications: Boolean
  daily_digest: Boolean
  new_job_alerts: Boolean
  preferred_locations: [String!]
  preferred_skills: [String!]
  excluded_companies: [String!]
  dark_mode: Boolean
  jobs_per_page: Int
}

type TextToSqlResult {
  sql: String!
  explanation: String
  columns: [String!]!
  rows: [[JSON]]!
  drilldownSearchQuery: String
}

type DeleteJobResponse {
  success: Boolean!
  message: String
}

"""
Response from triggering the classify-jobs Cloudflare Worker
"""
type ProcessAllJobsResponse {
  success: Boolean!
  message: String
  """
  Number of jobs enhanced with ATS data in this run
  """
  enhanced: Int
  """
  Number of errors during ATS enhancement
  """
  enhanceErrors: Int
  """
  Number of jobs classified in this run
  """
  processed: Int
  """
  Number of jobs classified as EU-remote
  """
  euRemote: Int
  """
  Number of jobs classified as non-EU
  """
  nonEuRemote: Int
  """
  Number of errors encountered during classification
  """
  errors: Int
}

"""
Response from enhancing a job with ATS data
"""
type EnhanceJobResponse {
  """
  Whether the enhancement was successful
  """
  success: Boolean!
  """
  Human-readable message about the operation result
  """
  message: String
  """
  The updated job record with enhanced data from the ATS
  """
  job: Job
  """
  Raw enhanced data from the ATS API (Greenhouse or Ashby).

  Greenhouse data includes:
  - content: Full HTML job description
  - departments: Array of department objects with id, name, child_ids, parent_id
  - offices: Array of office objects with id, name, location, child_ids, parent_id
  - questions: Application form questions
  - metadata: Custom fields
  - compliance: Compliance questions
  - demographic_questions: EEOC/diversity questions

  Ashby data includes:
  - department, team, employment type
  - compensation tiers and summary
  - secondary locations and address
  - remote status
  """
  enhancedData: JSON
}
